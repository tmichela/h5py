name: test
on: [push, pull_request]

env:
  HDF5_CACHE_DIR: ~/.cache/hdf5
  # - TOXENV=py37-test-deps
  HDF5_VERSION: 1.10.5
  HDF5_DIR: $HDF5_CACHE_DIR/$HDF5_VERSION
  H5PY_ENFORCE_COVERAGE: yes

jobs:
  unittest:
    name: Run unit tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.6, 3.7, 3.8]

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Cache dirs
        uses: actions/cache@v2
        with:
          path: |
            ~/.cache/pip
            ~/.cache/hdf5
            ~/.ccache
          key: ${{ runner.os }}-h5-${{ hashFiles('**/setup.py') }}
          restore-keys: ${{ runner.os }}-h5-

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
          # architecture: ppc64le

      - name: Install dependencies
        run: |
          ccache -s
          sudo apt update -q
          sudo apt install -y libhdf5-serial-dev
          sudo pip install tox codecov
          sudo ci/travis/get_hdf5_if_needed.sh
#          ls -lRa $HDF5_CACHE_DIR

      - name: Run tests
        shell: bash
        run: |
          PYVERSION=${{ matrix.python-version }}
          tox -re py"${PYVERSION//.}"-test-deps

  # apidoc:
  #   name: Build API doc
  #   needs: unittest
