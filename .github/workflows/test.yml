name: test
on: [push, pull_request]

env:
  HDF5_CACHE_DIR: ~/.cache/hdf5
  # - TOXENV=py37-test-deps
  HDF5_VERSION: 1.10.5
  HDF5_DIR: $HDF5_CACHE_DIR/$HDF5_VERSION
  H5PY_ENFORCE_COVERAGE: yes

jobs:
  unittest:
    name: Run unit tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.6, 3.7, 3.8]

    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          architecture: linux-ppc64le

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          sudo apt update -q
          sudo apt install -y libhdf5-serial-dev
          sudo pip install tox codecov
          sudo ci/travis/get_hdf5_if_needed.sh
        #  ls -lRa $HDF5_CACHE_DIR
        # with:
        #   path: |
        #     ~/.cache/pip
        #     ~/.cache/hdf5
        #     ~/.ccache

      - name: Run tests
        shell: bash
        run: |
          PYVERSION = ${{ matrix.python-version }}
          tox -re py"${PYVERSION//.}"-test-deps

  # apidoc:
  #   name: Build API doc
  #   needs: unittest
